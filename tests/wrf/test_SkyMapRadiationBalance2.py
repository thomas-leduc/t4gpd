"""
Created on 13 Apr. 2025

@author: tleduc

Copyright 2020-2025 Thomas Leduc

This file is part of t4gpd.

t4gpd is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

t4gpd is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with t4gpd.  If not, see <https://www.gnu.org/licenses/>.
"""
import unittest
from datetime import date
from geopandas import GeoDataFrame
from io import StringIO
from pandas import read_csv, to_datetime
from shapely.wkt import loads
from t4gpd.commons.ArrayCoding import ArrayCoding
from t4gpd.demos.GeoDataFrameDemos import GeoDataFrameDemos
from t4gpd.morph.STGrid import STGrid
from t4gpd.skymap.STSkyMap25D import STSkyMap25D
from t4gpd.wrf.SkyMapRadiationBalance2 import SkyMapRadiationBalance2


class SkyMapRadiationBalance2Test(unittest.TestCase):
    def setUp(self):
        self.buildings = GeoDataFrameDemos.ensaNantesBuildings()
        self.sensors = STGrid(
            self.buildings,
            dx=105,
            dy=None,
            indoor=False,
            intoPoint=True,
            withDist=False,
        ).run()  # < 0.02 sec.
        self.skymaps = STSkyMap25D(
            self.buildings,
            self.sensors,
            nRays=64,
            rayLength=100,
            elevationFieldname="HAUTEUR",
            h0=0.0,
            size=9.0,
            withIndices=True,
            withAngles=True,
            encode=False,
        ).run()  # < 0.3 sec.
        self.day = date(2022, 6, 13)

        self.sio = StringIO(
            """NUM_POSTE,NOM_USUEL,LAT,LON,ALTI,AAAAMMJJHH,RR1,QRR1,DRR1,QDRR1,FF,QFF,DD,QDD,FXY,QFXY,DXY,QDXY,HXY,QHXY,FXI,QFXI,DXI,QDXI,HXI,QHXI,FF2,QFF2,DD2,QDD2,FXI2,QFXI2,DXI2,QDXI2,HXI2,QHXI2,FXI3S,QFXI3S,DXI3S,QDXI3S,HFXI3S,QHFXI3S,T,QT,TD,QTD,TN,QTN,HTN,QHTN,TX,QTX,HTX,QHTX,DG,QDG,T10,QT10,T20,QT20,T50,QT50,T100,QT100,TNSOL,QTNSOL,TN50,QTN50,TCHAUSSEE,QTCHAUSSEE,DHUMEC,QDHUMEC,U,QU,UN,QUN,HUN,QHUN,UX,QUX,HUX,QHUX,DHUMI40,QDHUMI40,DHUMI80,QDHUMI80,TSV,QTSV,PMER,QPMER,PSTAT,QPSTAT,PMERMIN,QPERMIN,GEOP,QGEOP,N,QN,NBAS,QNBAS,CL,QCL,CM,QCM,CH,QCH,N1,QN1,C1,QC1,B1,QB1,N2,QN2,C2,QC2,B2,QCB2,N3,QN3,C3,QC3,B3,QB3,N4,QN4,C4,QC4,B4,QB4,VV,QVV,DVV200,QDVV200,WW,QWW,W1,QW1,W2,QW2,SOL,QSOL,SOLNG,QSOLNG,TMER,QTMER,VVMER,QVVMER,ETATMER,QETATMER,DIRHOULE,QDIRHOULE,HVAGUE,QHVAGUE,PVAGUE,QPVAGUE,HNEIGEF,QHNEIGEF,NEIGETOT,QNEIGETOT,TSNEIGE,QTSNEIGE,TUBENEIGE,QTUBENEIGE,HNEIGEFI3,QHNEIGEFI3,HNEIGEFI1,QHNEIGEFI1,ESNEIGE,QESNEIGE,CHARGENEIGE,QCHARGENEIGE,GLO,QGLO,GLO2,QGLO2,DIR,QDIR,DIR2,QDIR2,DIF,QDIF,DIF2,QDIF2,UV,QUV,UV2,QUV2,UV_INDICE,QUV_INDICE,INFRAR,QINFRAR,INFRAR2,QINFRAR2,INS,QINS,INS2,QINS2,TLAGON,QTLAGON,TVEGETAUX,QTVEGETAUX,ECOULEMENT,QECOULEMENT,timestamp,year,month,day,hour,day_of_year,weekday,geometry,GHI,solar_alti,solar_azim,sun_beam_dir,DNI,DHI
44020001,NANTES-BOUGUENAIS,47.15,-1.608833,26,2022061301,0.0,1.0,0.0,9.0,3.1,1.0,10.0,1.0,4.4,1.0,20.0,1.0,25.0,9.0,10.3,1.0,20.0,1.0,19.0,9.0,,,,,,,,,,,9.3,1.0,,,19.0,9.0,13.0,1.0,10.4,1.0,13.0,1.0,58.0,9.0,13.8,1.0,1.0,9.0,0.0,9.0,19.5,9.0,19.6,9.0,17.9,9.0,16.2,9.0,11.1,9.0,12.2,9.0,12.2,9.0,,,84.0,1.0,76.0,1.0,1.0,9.0,84.0,1.0,100.0,9.0,0.0,9.0,38.0,9.0,12.6,1.0,1025.4,1.0,1022.2,1.0,1025.3,1.0,,,,,0.0,9.0,,,,,,,,,,,7800.0,9.0,,,,,,,,,,,,,,,,,,,32860.0,9.0,0.0,9.0,0.0,9.0,,,,,0.0,9.0,,,,,,,,,,,,,,,,,0.0,9.0,,,,,,,,,,,,,0.0,9.0,0.0,9.0,,,,,,,,,,,,,,,,,,,0.0,9.0,0.0,9.0,,,,,,,2022-06-13 00:53:33.880080+00:00,2022,6,13,0,164,0,POINT (350961.6390793797 6682380.7909007715),0.0,-18.85349677199591,78.5511612162569,0.187843300917725#0.9275178360705588#-0.32314943613028496,0.0,0.0
44020001,NANTES-BOUGUENAIS,47.15,-1.608833,26,2022061302,0.0,1.0,0.0,9.0,3.6,1.0,10.0,1.0,4.1,1.0,10.0,1.0,116.0,9.0,8.8,1.0,10.0,1.0,115.0,9.0,,,,,,,,,,,7.4,1.0,,,115.0,9.0,12.5,1.0,10.4,1.0,12.5,1.0,159.0,9.0,13.1,1.0,107.0,9.0,0.0,9.0,19.3,9.0,19.5,9.0,18.0,9.0,16.2,9.0,10.6,9.0,11.7,9.0,11.9,9.0,,,87.0,1.0,84.0,1.0,101.0,9.0,87.0,1.0,140.0,9.0,0.0,9.0,60.0,9.0,12.6,1.0,1025.2,1.0,1022.0,1.0,1025.2,1.0,,,,,0.0,9.0,,,,,,,,,,,7800.0,9.0,,,,,,,,,,,,,,,,,,,19700.0,9.0,0.0,9.0,0.0,9.0,,,,,,,,,,,,,,,,,,,,,,,0.0,9.0,,,,,,,,,,,,,0.0,9.0,0.0,9.0,,,,,,,,,,,,,,,,,,,0.0,9.0,0.0,9.0,,,,,,,2022-06-13 01:53:33.880080+00:00,2022,6,13,1,164,0,POINT (350961.6390793797 6682380.7909007715),0.0,-15.617210795282546,64.5226243218998,0.41427410045373486#0.869427061366303#-0.26920912810899206,0.0,0.0
44020001,NANTES-BOUGUENAIS,47.15,-1.608833,26,2022061303,0.0,1.0,0.0,9.0,2.9,1.0,20.0,1.0,4.1,1.0,10.0,1.0,207.0,9.0,8.7,1.0,20.0,1.0,218.0,9.0,,,,,,,,,,,7.0,1.0,,,210.0,9.0,12.3,1.0,10.5,1.0,12.3,1.0,259.0,9.0,12.6,1.0,205.0,9.0,0.0,9.0,19.1,9.0,19.3,9.0,18.0,9.0,16.2,9.0,10.6,9.0,11.6,9.0,11.8,9.0,,,89.0,1.0,87.0,1.0,201.0,9.0,89.0,1.0,225.0,9.0,0.0,9.0,60.0,9.0,12.7,1.0,1025.1,1.0,1021.9,1.0,1025.1,1.0,,,,,0.0,9.0,,,,,,,,,,,7800.0,9.0,,,,,,,,,,,,,,,,,,,19215.0,9.0,0.0,9.0,0.0,9.0,,,,,1.0,9.0,,,,,,,,,,,,,,,,,0.0,9.0,,,,,,,,,,,,,0.0,9.0,0.0,9.0,,,,,,,,,,,,,,,,,,,0.0,9.0,0.0,9.0,,,,,,,2022-06-13 02:53:33.880080+00:00,2022,6,13,2,164,0,POINT (350961.6390793797 6682380.7909007715),0.0,-10.210020033466307,51.51350342404476,0.6124753424908727#0.7703596314351269#-0.17725685627310372,0.0,0.0
44020001,NANTES-BOUGUENAIS,47.15,-1.608833,26,2022061304,0.0,1.0,0.0,9.0,3.7,1.0,20.0,1.0,3.8,1.0,20.0,1.0,359.0,9.0,8.1,1.0,20.0,1.0,355.0,9.0,,,,,,,,,,,7.3,1.0,,,355.0,9.0,12.1,1.0,10.6,1.0,11.9,1.0,357.0,9.0,12.4,1.0,303.0,9.0,0.0,9.0,18.9,9.0,19.2,9.0,18.0,9.0,16.2,9.0,9.6,9.0,11.0,9.0,11.1,9.0,,,91.0,1.0,89.0,1.0,301.0,9.0,91.0,1.0,345.0,9.0,0.0,9.0,60.0,9.0,12.8,1.0,1025.1,1.0,1021.9,1.0,1025.1,1.0,,,,,0.0,9.0,,,,,,,,,,,7800.0,9.0,,,,,,,,,,,,,,,,,,,17026.0,9.0,0.0,9.0,0.0,9.0,,,,,1.0,9.0,,,,,,,,,,,,,,,,,0.0,9.0,,,,,,,,,,,,,0.0,9.0,0.0,9.0,,,,,,,,,,,,,,,,,,,0.0,9.0,0.0,9.0,,,,,,,2022-06-13 03:53:33.880080+00:00,2022,6,13,3,164,0,POINT (350961.6390793797 6682380.7909007715),0.0,-3.0699865048984365,39.6415580539761,0.7689455713775462#0.6370671010225113#-0.05355573782175555,0.0,0.0
44020001,NANTES-BOUGUENAIS,47.15,-1.608833,26,2022061305,0.0,1.0,0.0,9.0,2.3,1.0,30.0,1.0,3.6,1.0,20.0,1.0,401.0,9.0,7.1,1.0,30.0,1.0,409.0,9.0,,,,,,,,,,,6.4,1.0,,,410.0,9.0,12.6,1.0,10.9,1.0,11.9,1.0,419.0,9.0,12.6,1.0,500.0,9.0,0.0,9.0,18.7,9.0,19.1,9.0,18.0,9.0,16.2,9.0,9.5,9.0,11.1,9.0,11.1,9.0,,,89.0,1.0,89.0,1.0,449.0,9.0,91.0,1.0,401.0,9.0,0.0,9.0,60.0,9.0,13.0,1.0,1025.5,1.0,1022.3,1.0,1025.1,1.0,,,,,0.0,9.0,,,,,,,,,,,7800.0,9.0,,,,,,,,,,,,,,,,,,,16560.0,9.0,0.0,9.0,0.0,9.0,,,,,1.0,9.0,,,,,,,,,,,,,,,,,0.0,9.0,,,,,,,,,,,,,7.0,9.0,10.0,9.0,,,,,,,,,,,,,,,,,,,23.0,9.0,29.0,9.0,,,,,,,2022-06-13 04:53:33.880080+00:00,2022,6,13,4,164,0,POINT (350961.6390793797 6682380.7909007715),27.77777777777778,5.513768561735351,28.73354336315424,0.8728077369289869#0.4785126296236714#0.09608495016150828,0.0,27.77777777777778
44020001,NANTES-BOUGUENAIS,47.15,-1.608833,26,2022061306,0.0,1.0,0.0,9.0,3.9,1.0,40.0,1.0,4.0,1.0,40.0,1.0,558.0,9.0,8.2,1.0,40.0,1.0,550.0,9.0,,,,,,,,,,,7.5,1.0,,,550.0,9.0,14.1,1.0,10.6,1.0,12.6,1.0,501.0,9.0,14.1,1.0,559.0,9.0,0.0,9.0,18.6,9.0,18.9,9.0,18.0,9.0,16.1,9.0,11.1,9.0,12.7,9.0,12.0,9.0,,,80.0,1.0,80.0,1.0,557.0,9.0,89.0,1.0,501.0,9.0,0.0,9.0,60.0,9.0,12.8,1.0,1025.6,1.0,1022.5,1.0,1025.5,1.0,,,,,0.0,9.0,,,,,,,,,,,7800.0,9.0,,,,,,,,,,,,,,,,,,,18945.0,9.0,0.0,9.0,0.0,9.0,,,,,0.0,9.0,,,,,,,,,,,,,,,,,0.0,9.0,,,,,,,,,,,,,53.0,9.0,59.0,9.0,,,,,,,,,,,,,,,,,,,60.0,9.0,60.0,9.0,,,,,,,2022-06-13 05:53:33.880080+00:00,2022,6,13,5,164,0,POINT (350961.6390793797 6682380.7909007715),163.88888888888889,14.764102325284298,18.43356081889698,0.9173682605075303#0.30576472762798307#0.2548399614502667,252.64236176062624,99.50551915710658
44020001,NANTES-BOUGUENAIS,47.15,-1.608833,26,2022061307,0.0,1.0,0.0,9.0,4.1,1.0,40.0,1.0,4.1,1.0,40.0,1.0,629.0,9.0,8.0,1.0,30.0,1.0,659.0,9.0,,,,,,,,,,,7.0,1.0,,,659.0,9.0,15.7,1.0,9.3,1.0,14.2,1.0,601.0,9.0,15.7,1.0,654.0,9.0,0.0,9.0,18.4,9.0,18.8,9.0,18.0,9.0,16.2,9.0,15.7,9.0,17.3,9.0,13.9,9.0,,,66.0,1.0,66.0,1.0,700.0,9.0,80.0,1.0,601.0,9.0,0.0,9.0,2.0,9.0,11.7,1.0,1025.7,1.0,1022.6,1.0,1025.6,1.0,,,,,0.0,9.0,,,,,,,,,,,7800.0,9.0,,,,,,,,,,,,,,,,,,,19725.0,9.0,0.0,9.0,0.0,9.0,,,,,0.0,9.0,,,,,,,,,,,,,,,,,0.0,9.0,,,,,,,,,,,,,117.0,9.0,123.0,9.0,,,,,,,,,,,,,,,,,,,60.0,9.0,60.0,9.0,,,,,,,2022-06-13 06:53:33.880080+00:00,2022,6,13,6,164,0,POINT (350961.6390793797 6682380.7909007715),341.66666666666663,24.651094514085912,8.252765257004285,0.8994527392469306#0.1304587635743339#0.4170914538417793,545.352757999215,114.20469197615003
44020001,NANTES-BOUGUENAIS,47.15,-1.608833,26,2022061308,0.0,1.0,0.0,9.0,5.2,1.0,50.0,1.0,6.0,1.0,60.0,1.0,746.0,9.0,8.7,1.0,70.0,1.0,742.0,9.0,,,,,,,,,,,8.1,1.0,,,742.0,9.0,17.4,1.0,10.3,1.0,15.6,1.0,706.0,9.0,17.4,1.0,800.0,9.0,0.0,9.0,18.4,9.0,18.7,9.0,18.0,9.0,16.2,9.0,21.0,9.0,19.6,9.0,17.3,9.0,,,63.0,1.0,62.0,1.0,748.0,9.0,68.0,1.0,707.0,9.0,0.0,9.0,0.0,9.0,12.5,1.0,1025.8,1.0,1022.7,1.0,1025.6,1.0,,,,,0.0,9.0,,,,,,,,,,,7800.0,9.0,,,,,,,,,,,,,,,,,,,19382.0,9.0,0.0,9.0,0.0,9.0,,,,,0.0,9.0,,,,,,,,,,,,,,,,,0.0,9.0,,,,,,,,,,,,,181.0,9.0,187.0,9.0,,,,,,,,,,,,,,,,,,,60.0,9.0,60.0,9.0,,,,,,,2022-06-13 07:53:33.880080+00:00,2022,6,13,7,164,0,POINT (350961.6390793797 6682380.7909007715),519.4444444444445,34.81199932537321,357.52371667368266,0.8202629834280398#-0.0354732793968875#0.5708855265870396,714.4234833505167,111.59041794573756
44020001,NANTES-BOUGUENAIS,47.15,-1.608833,26,2022061309,0.0,1.0,0.0,9.0,5.5,1.0,50.0,1.0,6.0,1.0,50.0,1.0,810.0,9.0,9.6,1.0,70.0,1.0,843.0,9.0,,,,,,,,,,,9.3,1.0,,,843.0,9.0,18.6,1.0,9.9,1.0,17.1,1.0,815.0,9.0,18.6,1.0,900.0,9.0,0.0,9.0,18.4,9.0,18.6,9.0,18.0,9.0,16.2,9.0,26.4,9.0,21.6,9.0,26.5,9.0,,,57.0,1.0,56.0,1.0,851.0,9.0,62.0,1.0,801.0,9.0,0.0,9.0,0.0,9.0,12.2,1.0,1025.4,1.0,1022.3,1.0,1025.4,1.0,,,,,0.0,9.0,,,,,,,,,,,7800.0,9.0,,,,,,,,,,,,,,,,,,,19565.0,9.0,0.0,9.0,0.0,9.0,,,,,0.0,9.0,,,,,,,,,,,,,,,,,0.0,9.0,,,,,,,,,,,,,239.0,9.0,245.0,9.0,,,,,,,,,,,,,,,,,,,60.0,9.0,60.0,9.0,,,,,,,2022-06-13 08:53:33.880080+00:00,2022,6,13,8,164,0,POINT (350961.6390793797 6682380.7909007715),680.5555555555555,44.87676175470242,345.22418250784204,0.6851925970403284#-0.18072634415582686#0.7055842214003937,773.957561232256,134.46331231654676
44020001,NANTES-BOUGUENAIS,47.15,-1.608833,26,2022061310,0.0,1.0,0.0,9.0,5.4,1.0,60.0,1.0,6.0,1.0,60.0,1.0,919.0,9.0,9.7,1.0,50.0,1.0,951.0,9.0,,,,,,,,,,,9.0,1.0,,,939.0,9.0,20.0,1.0,9.8,1.0,18.6,1.0,901.0,9.0,20.1,1.0,956.0,9.0,0.0,9.0,18.5,9.0,18.6,9.0,17.9,9.0,16.2,9.0,29.8,9.0,23.7,9.0,34.3,9.0,,,52.0,1.0,51.0,1.0,926.0,9.0,58.0,1.0,905.0,9.0,0.0,9.0,0.0,9.0,12.1,1.0,1025.1,1.0,1022.0,1.0,1025.1,1.0,,,,,0.0,9.0,,,,,,,,,,,7800.0,9.0,,,,,,,,,,,,,,,,,,,24024.0,9.0,0.0,9.0,0.0,9.0,,,,,0.0,9.0,,,,,,,,,,,,,,,,,0.0,9.0,,,,,,,,,,,,,289.0,9.0,293.0,9.0,,,,,,,,,,,,,,,,,,,60.0,9.0,60.0,9.0,,,,,,,2022-06-13 09:53:33.880080+00:00,2022,6,13,9,164,0,POINT (350961.6390793797 6682380.7909007715),813.8888888888889,54.287974635468935,329.59711119596005,0.5034443753709532#-0.2954031821534002#0.811961034090304,847.2338804954919,125.9679911654282
44020001,NANTES-BOUGUENAIS,47.15,-1.608833,26,2022061311,0.0,1.0,0.0,9.0,3.8,1.0,40.0,1.0,5.3,1.0,60.0,1.0,1001.0,9.0,8.2,1.0,100.0,1.0,1027.0,9.0,,,,,,,,,,,7.7,1.0,,,1027.0,9.0,21.5,1.0,10.0,1.0,20.2,1.0,1001.0,9.0,21.5,1.0,1058.0,9.0,0.0,9.0,18.7,9.0,18.6,9.0,17.9,9.0,16.2,9.0,32.2,9.0,25.5,9.0,43.3,9.0,,,48.0,1.0,47.0,1.0,1059.0,9.0,53.0,1.0,1001.0,9.0,0.0,9.0,0.0,9.0,12.3,1.0,1024.7,1.0,1021.6,1.0,1024.7,1.0,,,,,0.0,9.0,,,,,,,,,,,7800.0,9.0,,,,,,,,,,,,,,,,,,,26712.0,9.0,0.0,9.0,0.0,9.0,,,,,0.0,9.0,,,,,,,,,,,,,,,,,0.0,9.0,,,,,,,,,,,,,323.0,9.0,326.0,9.0,,,,,,,,,,,,,,,,,,,60.0,9.0,60.0,9.0,,,,,,,2022-06-13 10:53:33.880080+00:00,2022,6,13,10,164,0,POINT (350961.6390793797 6682380.7909007715),905.5555555555555,61.97585169586277,307.7122950388504,0.2874018666220564#-0.3716896917335142#0.8827496474772465,869.4170929349725,138.077923256516
44020001,NANTES-BOUGUENAIS,47.15,-1.608833,26,2022061312,0.0,1.0,0.0,9.0,3.7,1.0,30.0,1.0,4.8,1.0,60.0,1.0,1110.0,9.0,10.8,1.0,90.0,1.0,1142.0,9.0,,,,,,,,,,,9.3,1.0,,,1142.0,9.0,22.9,1.0,9.7,1.0,21.5,1.0,1101.0,9.0,22.9,1.0,1200.0,9.0,0.0,9.0,19.0,9.0,18.6,9.0,17.9,9.0,16.2,9.0,35.2,9.0,27.6,9.0,48.5,9.0,,,43.0,1.0,43.0,1.0,1138.0,9.0,50.0,1.0,1107.0,9.0,0.0,9.0,0.0,9.0,12.0,1.0,1024.2,1.0,1021.1,1.0,1024.2,1.0,,,,,0.0,9.0,,,,,,,,,,,7800.0,9.0,,,,,,,,,,,,,,,,,,,19868.0,9.0,0.0,9.0,0.0,9.0,,,,,0.0,9.0,,,,,,,,,,,,,,,,,0.0,9.0,,,,,,,,,,,,,344.0,9.0,345.0,9.0,,,,,,,,,,,,,,,,,,,60.0,9.0,60.0,9.0,,,,,,,2022-06-13 11:53:33.880080+00:00,2022,6,13,11,164,0,POINT (350961.6390793797 6682380.7909007715),958.3333333333333,65.94020313446032,277.2974946901774,0.051785268436683754#-0.4043875564052247#0.9131204686116459,947.4818211417171,93.16828881139281
44020001,NANTES-BOUGUENAIS,47.15,-1.608833,26,2022061313,0.0,1.0,0.0,9.0,4.6,1.0,60.0,1.0,4.9,1.0,70.0,1.0,1235.0,9.0,8.8,1.0,70.0,1.0,1228.0,9.0,,,,,,,,,,,8.5,1.0,,,1228.0,9.0,23.3,1.0,8.5,1.0,22.5,1.0,1207.0,9.0,23.6,1.0,1247.0,9.0,0.0,9.0,19.4,9.0,18.7,9.0,17.9,9.0,16.2,9.0,35.3,9.0,28.1,9.0,50.2,9.0,,,39.0,1.0,38.0,1.0,1253.0,9.0,46.0,1.0,1209.0,9.0,19.0,9.0,0.0,9.0,11.1,1.0,1023.4,1.0,1020.4,1.0,1023.4,1.0,,,,,0.0,9.0,,,,,,,,,,,7800.0,9.0,,,,,,,,,,,,,,,,,,,30290.0,9.0,0.0,9.0,0.0,9.0,,,,,0.0,9.0,,,,,,,,,,,,,,,,,0.0,9.0,,,,,,,,,,,,,346.0,9.0,346.0,9.0,,,,,,,,,,,,,,,,,,,60.0,9.0,60.0,9.0,,,,,,,2022-06-13 12:53:33.880080+00:00,2022,6,13,12,164,0,POINT (350961.6390793797 6682380.7909007715),961.1111111111111,64.29036034607333,244.41343771093054,-0.1873516521109148#-0.391268531381409#0.9010040481606874,910.0083941994708,141.18986407718137
44020001,NANTES-BOUGUENAIS,47.15,-1.608833,26,2022061314,0.0,1.0,0.0,9.0,3.8,1.0,30.0,1.0,5.0,1.0,50.0,1.0,1327.0,9.0,8.7,1.0,30.0,1.0,1325.0,9.0,,,,,,,,,,,7.8,1.0,,,1325.0,9.0,24.6,1.0,8.5,1.0,23.5,1.0,1301.0,9.0,24.8,1.0,1350.0,9.0,0.0,9.0,19.8,9.0,18.9,9.0,17.9,9.0,16.2,9.0,35.9,9.0,29.0,9.0,50.0,9.0,,,36.0,1.0,34.0,1.0,1328.0,9.0,41.0,1.0,1312.0,9.0,59.0,9.0,0.0,9.0,11.1,1.0,1022.8,1.0,1019.8,1.0,1022.8,1.0,,,,,0.0,9.0,,,,,,,,,,,7800.0,9.0,,,,,,,,,,,,,,,,,,,30243.0,9.0,0.0,9.0,0.0,9.0,,,,,2.0,9.0,,,,,,,,,,,,,,,,,0.0,9.0,,,,,,,,,,,,,331.0,9.0,327.0,9.0,,,,,,,,,,,,,,,,,,,60.0,9.0,60.0,9.0,,,,,,,2022-06-13 13:53:33.880080+00:00,2022,6,13,13,164,0,POINT (350961.6390793797 6682380.7909007715),908.3333333333333,57.91170483005777,218.84963440926052,-0.41371569581227363#-0.33322645057006217#0.8472304619635935,926.172675532608,123.65162958378437
44020001,NANTES-BOUGUENAIS,47.15,-1.608833,26,2022061315,0.0,1.0,0.0,9.0,4.3,1.0,60.0,1.0,4.9,1.0,60.0,1.0,1452.0,9.0,9.4,1.0,60.0,1.0,1432.0,9.0,,,,,,,,,,,8.1,1.0,,,1432.0,9.0,24.8,1.0,7.8,1.0,24.3,1.0,1402.0,9.0,25.0,1.0,1415.0,9.0,0.0,9.0,20.2,9.0,19.1,9.0,17.8,9.0,16.2,9.0,35.9,9.0,29.8,9.0,46.6,9.0,,,34.0,1.0,32.0,1.0,1411.0,9.0,38.0,1.0,1405.0,9.0,60.0,9.0,0.0,9.0,10.6,1.0,1022.3,1.0,1019.3,1.0,1022.3,1.0,,,,,0.0,9.0,,,,,,,,,,,7800.0,9.0,,,,,,,,,,,,,,,,,,,30373.0,9.0,0.0,9.0,0.0,9.0,,,,,2.0,9.0,,,,,,,,,,,,,,,,,0.0,9.0,,,,,,,,,,,,,297.0,9.0,292.0,9.0,,,,,,,,,,,,,,,,,,,60.0,9.0,60.0,9.0,,,,,,,2022-06-13 14:53:33.880080+00:00,2022,6,13,14,164,0,POINT (350961.6390793797 6682380.7909007715),811.1111111111111,49.06673525181231,200.9457474889965,-0.6118848408566468#-0.2342160675432346#0.7554732127841588,939.4785267707786,101.36025014986251
44020001,NANTES-BOUGUENAIS,47.15,-1.608833,26,2022061316,0.0,1.0,0.0,9.0,4.2,1.0,60.0,1.0,5.1,1.0,60.0,1.0,1530.0,9.0,8.5,1.0,50.0,1.0,1503.0,9.0,,,,,,,,,,,7.9,1.0,,,1510.0,9.0,25.1,1.0,7.7,1.0,24.5,1.0,1537.0,9.0,25.3,1.0,1548.0,9.0,0.0,9.0,20.5,9.0,19.4,9.0,17.9,9.0,16.2,9.0,34.9,9.0,29.5,9.0,42.7,9.0,,,33.0,1.0,28.0,1.0,1535.0,9.0,35.0,1.0,1501.0,9.0,60.0,9.0,0.0,9.0,10.5,1.0,1021.8,1.0,1018.8,1.0,1021.8,1.0,,,,,0.0,9.0,,,,,,,,,,,7800.0,9.0,,,,,,,,,,,,,,,,,,,37701.0,9.0,0.0,9.0,0.0,9.0,,,,,0.0,9.0,,,,,,,,,,,,,,,,,0.0,9.0,,,,,,,,,,,,,246.0,9.0,239.0,9.0,,,,,,,,,,,,,,,,,,,60.0,9.0,60.0,9.0,,,,,,,2022-06-13 15:53:33.880080+00:00,2022,6,13,15,164,0,POINT (350961.6390793797 6682380.7909007715),663.8888888888889,39.19799421516551,187.4873076492164,-0.7683590562056235#-0.1009832342635147#0.6320021733700634,917.7665418809901,83.8584397737759
44020001,NANTES-BOUGUENAIS,47.15,-1.608833,26,2022061317,0.0,1.0,0.0,9.0,4.1,1.0,50.0,1.0,5.3,1.0,60.0,1.0,1649.0,9.0,10.8,1.0,60.0,1.0,1645.0,9.0,,,,,,,,,,,8.0,1.0,,,1616.0,9.0,24.6,1.0,7.3,1.0,24.6,1.0,1611.0,9.0,25.4,1.0,1602.0,9.0,0.0,9.0,20.7,9.0,19.6,9.0,17.8,9.0,16.2,9.0,32.6,9.0,28.7,9.0,33.5,9.0,,,33.0,1.0,30.0,1.0,1604.0,9.0,35.0,1.0,1654.0,9.0,60.0,9.0,0.0,9.0,10.2,1.0,1021.0,1.0,1018.0,1.0,1021.0,1.0,,,,,0.0,9.0,,,,,,,,,,,7800.0,9.0,,,,,,,,,,,,,,,,,,,38360.0,9.0,0.0,9.0,0.0,9.0,,,,,0.0,9.0,,,,,,,,,,,,,,,,,0.0,9.0,,,,,,,,,,,,,186.0,9.0,179.0,9.0,,,,,,,,,,,,,,,,,,,60.0,9.0,60.0,9.0,,,,,,,2022-06-13 16:53:33.880080+00:00,2022,6,13,16,164,0,POINT (350961.6390793797 6682380.7909007715),497.22222222222223,29.029973274404945,176.2362916756515,-0.8724801761386904#0.0573950176220498#0.48526709572890303,848.9475550790106,85.25590774287775
44020001,NANTES-BOUGUENAIS,47.15,-1.608833,26,2022061318,0.0,1.0,0.0,9.0,3.8,1.0,50.0,1.0,4.7,1.0,50.0,1.0,1710.0,9.0,9.1,1.0,30.0,1.0,1705.0,9.0,,,,,,,,,,,7.9,1.0,,,1710.0,9.0,24.4,1.0,8.0,1.0,24.4,1.0,1728.0,9.0,24.9,1.0,1710.0,9.0,0.0,9.0,20.8,9.0,19.8,9.0,17.9,9.0,16.2,9.0,29.9,9.0,27.7,9.0,25.2,9.0,,,35.0,1.0,33.0,1.0,1701.0,9.0,36.0,1.0,1705.0,9.0,60.0,9.0,0.0,9.0,10.7,1.0,1020.8,1.0,1017.8,1.0,1020.8,1.0,,,,,0.0,9.0,,,,,,,,,,,7800.0,9.0,,,,,,,,,,,,,,,,,,,47463.0,9.0,0.0,9.0,0.0,9.0,,,,,0.0,9.0,,,,,,,,,,,,,,,,,0.0,9.0,,,,,,,,,,,,,122.0,9.0,114.0,9.0,,,,,,,,,,,,,,,,,,,60.0,9.0,60.0,9.0,,,,,,,2022-06-13 17:53:33.880080+00:00,2022,6,13,17,164,0,POINT (350961.6390793797 6682380.7909007715),316.66666666666663,18.987518471905105,165.91438231629536,-0.9171585666084647#0.23012957461245667#0.32536217141117674,663.8080857812796,100.68862647657278
44020001,NANTES-BOUGUENAIS,47.15,-1.608833,26,2022061319,0.0,1.0,0.0,9.0,2.8,1.0,30.0,1.0,3.7,1.0,40.0,1.0,1801.0,9.0,7.1,1.0,50.0,1.0,1811.0,9.0,,,,,,,,,,,6.3,1.0,,,1817.0,9.0,23.2,1.0,9.2,1.0,23.2,1.0,1900.0,9.0,24.4,1.0,1801.0,9.0,0.0,9.0,20.8,9.0,20.0,9.0,17.9,9.0,16.2,9.0,22.8,9.0,23.7,9.0,20.6,9.0,,,41.0,1.0,35.0,1.0,1801.0,9.0,41.0,1.0,1859.0,9.0,58.0,9.0,0.0,9.0,11.6,1.0,1020.7,1.0,1017.7,1.0,1020.6,1.0,,,,,0.0,9.0,,,,,,,,,,,7800.0,9.0,,,,,,,,,,,,,,,,,,,32426.0,9.0,0.0,9.0,0.0,9.0,,,,,0.0,9.0,,,,,,,,,,,,,,,,,0.0,9.0,,,,,,,,,,,,,59.0,9.0,52.0,9.0,,,,,,,,,,,,,,,,,,,60.0,9.0,60.0,9.0,,,,,,,2022-06-13 18:53:33.880080+00:00,2022,6,13,18,164,0,POINT (350961.6390793797 6682380.7909007715),144.44444444444443,9.4140582817751,155.73277555024134,-0.8993606355787046#0.40545770194365227#0.1635680259281775,342.21229812487064,88.46945439181434
44020001,NANTES-BOUGUENAIS,47.15,-1.608833,26,2022061320,0.0,1.0,0.0,9.0,2.6,1.0,20.0,1.0,3.1,1.0,30.0,1.0,1941.0,9.0,6.3,1.0,20.0,1.0,1917.0,9.0,,,,,,,,,,,5.6,1.0,,,1910.0,9.0,21.3,1.0,9.6,1.0,21.3,1.0,2000.0,9.0,23.1,1.0,1901.0,9.0,0.0,9.0,20.7,9.0,20.1,9.0,17.9,9.0,16.2,9.0,18.6,9.0,20.3,9.0,17.6,9.0,,,47.0,1.0,41.0,1.0,1901.0,9.0,47.0,1.0,2000.0,9.0,0.0,9.0,0.0,9.0,11.9,1.0,1020.7,1.0,1017.6,1.0,1020.7,1.0,,,,,0.0,9.0,,,,,,,,,,,7800.0,9.0,,,,,,,,,,,,,,,,,,,38309.0,9.0,0.0,9.0,0.0,9.0,,,,,0.0,9.0,,,,,,,,,,,,,,,,,0.0,9.0,,,,,,,,,,,,,10.0,9.0,8.0,9.0,,,,,,,,,,,,,,,,,,,35.0,9.0,28.0,9.0,,,,,,,2022-06-13 19:53:33.880080+00:00,2022,6,13,19,164,0,POINT (350961.6390793797 6682380.7909007715),22.22222222222222,0.8729045259052468,145.13795594711382,-0.8204354938764855#0.5715360980303169#0.015234468678861048,0.0,22.22222222222222
44020001,NANTES-BOUGUENAIS,47.15,-1.608833,26,2022061321,0.0,1.0,0.0,9.0,2.4,1.0,30.0,1.0,3.4,1.0,30.0,1.0,2037.0,9.0,6.6,1.0,50.0,1.0,2028.0,9.0,,,,,,,,,,,6.0,1.0,,,2031.0,9.0,20.2,1.0,10.0,1.0,20.2,1.0,2059.0,9.0,21.4,1.0,2003.0,9.0,0.0,9.0,20.6,9.0,20.1,9.0,17.9,9.0,16.2,9.0,16.8,9.0,18.8,9.0,16.1,9.0,,,52.0,1.0,46.0,1.0,2002.0,9.0,52.0,1.0,2058.0,9.0,0.0,9.0,0.0,9.0,12.3,1.0,1021.0,1.0,1017.9,1.0,1020.7,1.0,,,,,0.0,9.0,,,,,,,,,,,7800.0,9.0,,,,,,,,,,,,,,,,,,,34832.0,9.0,0.0,9.0,0.0,9.0,,,,,0.0,9.0,,,,,,,,,,,,,,,,,0.0,9.0,,,,,,,,,,,,,0.0,9.0,0.0,9.0,,,,,,,,,,,,,,,,,,,0.0,9.0,0.0,9.0,,,,,,,2022-06-13 20:53:33.880080+00:00,2022,6,13,20,164,0,POINT (350961.6390793797 6682380.7909007715),0.0,-7.285262829765378,133.71630519627644,-0.6855090340105173#0.716935646209708#-0.12680947710575868,0.0,0.0
44020001,NANTES-BOUGUENAIS,47.15,-1.608833,26,2022061322,0.0,1.0,0.0,9.0,3.2,1.0,20.0,1.0,3.2,1.0,10.0,1.0,2159.0,9.0,6.3,1.0,30.0,1.0,2152.0,9.0,,,,,,,,,,,5.5,1.0,,,2153.0,9.0,18.8,1.0,10.4,1.0,18.8,1.0,2200.0,9.0,20.2,1.0,2106.0,9.0,0.0,9.0,20.4,9.0,20.1,9.0,18.0,9.0,16.2,9.0,15.7,9.0,17.6,9.0,15.2,9.0,,,58.0,1.0,52.0,1.0,2101.0,9.0,58.0,1.0,2159.0,9.0,0.0,9.0,0.0,9.0,12.6,1.0,1020.9,1.0,1017.8,1.0,1020.9,1.0,,,,,0.0,9.0,,,,,,,,,,,7800.0,9.0,,,,,,,,,,,,,,,,,,,34434.0,9.0,0.0,9.0,0.0,9.0,,,,,0.0,9.0,,,,,,,,,,,,,,,,,0.0,9.0,,,,,,,,,,,,,0.0,9.0,0.0,9.0,,,,,,,,,,,,,,,,,,,0.0,9.0,0.0,9.0,,,,,,,2022-06-13 21:53:33.880080+00:00,2022,6,13,21,164,0,POINT (350961.6390793797 6682380.7909007715),0.0,-13.488248049970135,121.20548340545122,-0.5038182765686706#0.8317232032918798#-0.23324591593695465,0.0,0.0
44020001,NANTES-BOUGUENAIS,47.15,-1.608833,26,2022061323,0.0,1.0,0.0,9.0,3.5,1.0,10.0,1.0,3.7,1.0,20.0,1.0,2208.0,9.0,7.2,1.0,30.0,1.0,2227.0,9.0,,,,,,,,,,,6.4,1.0,,,2227.0,9.0,16.8,1.0,11.6,1.0,16.8,1.0,2257.0,9.0,18.8,1.0,2201.0,9.0,0.0,9.0,20.2,9.0,20.1,9.0,18.0,9.0,16.2,9.0,14.2,9.0,15.7,9.0,14.4,9.0,,,71.0,1.0,58.0,1.0,2201.0,9.0,71.0,1.0,2254.0,9.0,0.0,9.0,0.0,9.0,13.6,1.0,1021.0,1.0,1017.9,1.0,1020.9,1.0,,,,,0.0,9.0,,,,,,,,,,,7800.0,9.0,,,,,,,,,,,,,,,,,,,32188.0,9.0,0.0,9.0,0.0,9.0,,,,,0.0,9.0,,,,,,,,,,,,,,,,,0.0,9.0,,,,,,,,,,,,,0.0,9.0,0.0,9.0,,,,,,,,,,,,,,,,,,,0.0,9.0,0.0,9.0,,,,,,,2022-06-13 22:53:33.880080+00:00,2022,6,13,22,164,0,POINT (350961.6390793797 6682380.7909007715),0.0,-17.70274553082944,107.58485756169273,-0.28781174698949613#0.9081302417451524#-0.30407871073579834,0.0,0.0
"""
        )
        self.meteo = read_csv(self.sio, sep=",")
        self.meteo.timestamp = to_datetime(self.meteo.timestamp)
        self.meteo.sun_beam_dir = self.meteo.sun_beam_dir.apply(lambda t: ArrayCoding.decode(t))
        self.meteo.geometry = self.meteo.geometry.apply(lambda geom: loads(geom))
        self.meteo = GeoDataFrame(self.meteo, crs="epsg:2154")

    def tearDown(self):
        pass

    def __plot(self, actual):
        import matplotlib.pyplot as plt
        from matplotlib.colors import ListedColormap

        my_cmap = ListedColormap(["red", "green", "blue"])

        fig, ax = plt.subplots(figsize=(1 * 8.26, 1 * 8.26))
        self.sensors.plot(ax=ax, color="red", marker="P")
        self.buildings.plot(ax=ax, color="lightgrey", edgecolor="darkgrey")
        # self.skymaps.plot(ax=ax)
        actual.plot(ax=ax, column="sw_direct", legend=True)
        ax.axis("off")
        fig.tight_layout()
        plt.show()
        plt.close(fig)

    def testRun1(self):
        actual = SkyMapRadiationBalance2(self.skymaps, self.day, meteo=None).run()
        self.assertIsInstance(actual, GeoDataFrame, "Is a GeoDataFrame")
        self.assertEqual(len(self.sensors), len(actual), "Count rows")
        self.assertEqual(len(self.sensors.columns) + 16, len(actual.columns), "Count columns")
        self.assertTrue(actual.sw_direct.apply(lambda v: 2100 < v < 2800).all(), "Test sw_direct attribute values")
        self.assertTrue(actual.sw_diffuse.apply(lambda v: 300 < v < 600).all(), "Test sw_diffuse attribute values")
        # self.__plot(actual)

    def testRun2(self):
        actual = SkyMapRadiationBalance2(self.skymaps, self.day, meteo=self.meteo).run()
        self.assertIsInstance(actual, GeoDataFrame, "Is a GeoDataFrame")
        self.assertEqual(len(self.sensors), len(actual), "Count rows")
        self.assertEqual(len(self.sensors.columns) + 16, len(actual.columns), "Count columns")
        self.assertTrue(actual.sw_direct.apply(lambda v: 2400 < v < 2800).all(), "Test sw_direct attribute values")
        self.assertTrue(actual.sw_diffuse.apply(lambda v: 300 < v < 700).all(), "Test sw_diffuse attribute values")
        # self.__plot(actual)


if __name__ == "__main__":
    # import sys;sys.argv = ['', 'Test.testName']
    unittest.main()
